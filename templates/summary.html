<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summary - Expense Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }

        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            color: #3b82f6;
            text-decoration: none;
        }
        .nav a:hover {
            text-decoration: underline;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toggle-group {
            background: white;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
        }
        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            color: #333;
        }
        .toggle-btn.active {
            background: #3b82f6;
            color: white;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .filters h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        .filter-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .filter-option input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .filter-option label {
            cursor: pointer;
            font-size: 14px;
        }

        .period-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            overflow: hidden;
        }
        .period-header {
            padding: 16px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .period-header h2 {
            font-size: 18px;
            color: #333;
        }
        .period-totals {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .period-total-item {
            text-align: right;
        }
        .period-total-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        .period-total-value {
            font-size: 18px;
            font-weight: bold;
        }
        .period-total-value.income { color: #10b981; }
        .period-total-value.costs { color: #ef4444; }
        .period-total-value.net-positive { color: #10b981; }
        .period-total-value.net-negative { color: #ef4444; }
        .period-categories {
            padding: 16px 20px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        @media (max-width: 900px) {
            .period-categories {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 600px) {
            .period-categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }
        .category-item.hidden {
            visibility: hidden;
        }
        .category-name {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .category-dot.operations { background: #3b82f6; }
        .category-dot.freelancers { background: #ec4899; }
        .category-dot.equipment { background: #f59e0b; }
        .category-dot.other { background: #6b7280; }
        .category-dot.uncategorized { background: #d1d5db; }
        .category-amount {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/">&larr; Back to Expenses</a>
        </div>

        <h1>Summary</h1>

        <div class="controls">
            <div class="toggle-group">
                <button class="toggle-btn active" id="toggleMonthly" onclick="setView('monthly')">Monthly</button>
                <button class="toggle-btn" id="toggleYearly" onclick="setView('yearly')">Yearly</button>
            </div>

            <div class="filters">
                <h3>Filter by Category</h3>
                <div class="filter-options">
                    <div class="filter-option">
                        <input type="checkbox" id="filter-operations" checked onchange="renderData()">
                        <label for="filter-operations">Operations</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-freelancers" checked onchange="renderData()">
                        <label for="filter-freelancers">Freelancers</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-equipment" checked onchange="renderData()">
                        <label for="filter-equipment">Equipment</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-other" checked onchange="renderData()">
                        <label for="filter-other">Other</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-uncategorized" checked onchange="renderData()">
                        <label for="filter-uncategorized">Uncategorized</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="dataContainer"></div>
    </div>

    <script>
        let monthsData = [];
        let yearsData = [];
        let currentView = 'monthly';

        function formatNumber(num) {
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function getActiveFilters() {
            return {
                operations: document.getElementById('filter-operations').checked,
                freelancers: document.getElementById('filter-freelancers').checked,
                equipment: document.getElementById('filter-equipment').checked,
                other: document.getElementById('filter-other').checked,
                uncategorized: document.getElementById('filter-uncategorized').checked
            };
        }

        function getCategoryLabel(key) {
            const labels = {
                operations: 'Operations',
                freelancers: 'Freelancers',
                equipment: 'Equipment',
                other: 'Other',
                uncategorized: 'Uncategorized'
            };
            return labels[key] || key;
        }

        function setView(view) {
            currentView = view;
            document.getElementById('toggleMonthly').classList.toggle('active', view === 'monthly');
            document.getElementById('toggleYearly').classList.toggle('active', view === 'yearly');
            renderData();
        }

        function renderData() {
            const data = currentView === 'monthly' ? monthsData : yearsData;
            const container = document.getElementById('dataContainer');
            const filters = getActiveFilters();
            const categoryOrder = ['operations', 'freelancers', 'equipment', 'other', 'uncategorized'];

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No data available</div>';
                return;
            }

            container.innerHTML = data.map(period => {
                const filteredTotal = categoryOrder
                    .filter(key => filters[key])
                    .reduce((sum, key) => sum + (period.categories[key] || 0), 0);

                const netValue = period.income - filteredTotal;
                const netClass = netValue >= 0 ? 'net-positive' : 'net-negative';

                const categoriesHtml = categoryOrder.map(key => {
                    const val = period.categories[key] || 0;
                    const hiddenClass = filters[key] ? '' : 'hidden';
                    return `
                        <div class="category-item ${hiddenClass}">
                            <span class="category-name">
                                <span class="category-dot ${key}"></span>
                                ${getCategoryLabel(key)}
                            </span>
                            <span class="category-amount">&euro;${formatNumber(val)}</span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="period-card">
                        <div class="period-header">
                            <h2>${period.label}</h2>
                            <div class="period-totals">
                                <div class="period-total-item">
                                    <div class="period-total-label">Income</div>
                                    <div class="period-total-value income">&euro;${formatNumber(period.income)}</div>
                                </div>
                                <div class="period-total-item">
                                    <div class="period-total-label">Costs</div>
                                    <div class="period-total-value costs">&euro;${formatNumber(filteredTotal)}</div>
                                </div>
                                <div class="period-total-item">
                                    <div class="period-total-label">Net</div>
                                    <div class="period-total-value ${netClass}">&euro;${formatNumber(netValue)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="period-categories">
                            ${categoriesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadData() {
            try {
                const [monthlyRes, yearlyRes] = await Promise.all([
                    fetch('/api/monthly-summary'),
                    fetch('/api/yearly-summary')
                ]);
                const monthlyData = await monthlyRes.json();
                const yearlyData = await yearlyRes.json();
                monthsData = monthlyData.months;
                yearsData = yearlyData.years;
                renderData();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('dataContainer').innerHTML =
                    '<div class="empty-state">Failed to load data</div>';
            }
        }

        loadData();
    </script>
</body>
</html>
